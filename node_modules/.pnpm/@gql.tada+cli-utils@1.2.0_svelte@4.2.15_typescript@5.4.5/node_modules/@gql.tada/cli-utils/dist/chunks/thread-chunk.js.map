{"version":3,"file":"thread-chunk.js","sources":["../../src/commands/generate-persisted/thread.ts"],"sourcesContent":["import * as path from 'node:path';\nimport { print } from '@0no-co/graphql.web';\nimport { Project, ts } from 'ts-morph';\n\nimport type { FragmentDefinitionNode } from '@0no-co/graphql.web';\nimport type { GraphQLSPConfig } from '@gql.tada/internal';\n\nimport {\n  init,\n  findAllPersistedCallExpressions,\n  getDocumentReferenceFromTypeQuery,\n  getDocumentReferenceFromDocumentNode,\n  unrollTadaFragments,\n} from '@0no-co/graphqlsp/api';\n\nimport { createPluginInfo, getFilePosition, loadVirtualCode } from '../../ts';\nimport { expose } from '../../threads';\n\nimport type { PersistedSignal, PersistedWarning } from './types';\n\nexport interface PersistedParams {\n  rootPath: string;\n  configPath: string;\n  pluginConfig: GraphQLSPConfig;\n}\n\nasync function* _runPersisted(params: PersistedParams): AsyncIterableIterator<PersistedSignal> {\n  init({ typescript: ts });\n\n  const projectPath = path.dirname(params.configPath);\n  const project = new Project({ tsConfigFilePath: params.configPath });\n\n  const getVirtualPosition = await loadVirtualCode(projectPath, project, ts);\n  if (!!getVirtualPosition) {\n    yield { kind: 'EXTERNAL_WARNING' };\n  }\n\n  const pluginInfo = createPluginInfo(\n    project,\n    params.pluginConfig,\n    projectPath,\n    getVirtualPosition\n  );\n\n  // Filter source files by whether they're under the relevant root path\n  const sourceFiles = project.getSourceFiles().filter((sourceFile) => {\n    const filePath = path.resolve(projectPath, sourceFile.getFilePath());\n    const relative = path.relative(params.rootPath, filePath);\n    return !relative.startsWith('..');\n  });\n\n  yield {\n    kind: 'FILE_COUNT',\n    fileCount: sourceFiles.length,\n  };\n\n  for (const { compilerNode: sourceFile } of sourceFiles) {\n    let filePath = sourceFile.fileName;\n    const documents: Record<string, string> = {};\n    const warnings: PersistedWarning[] = [];\n\n    const calls = findAllPersistedCallExpressions(sourceFile);\n    for (const call of calls) {\n      const position = getFilePosition(sourceFile, call.getStart(), undefined, getVirtualPosition);\n      filePath = position.file;\n\n      const hashArg = call.arguments[0];\n      const docArg = call.arguments[1];\n      const typeQuery = call.typeArguments && call.typeArguments[0];\n      if (!hashArg || !ts.isStringLiteral(hashArg)) {\n        warnings.push({\n          message:\n            '\"graphql.persisted\" must be called with a string literal as the first argument.',\n          file: position.file,\n          line: position.line,\n          col: position.col,\n        });\n        continue;\n      } else if (!docArg && !typeQuery) {\n        warnings.push({\n          message:\n            '\"graphql.persisted\" is missing a document.\\n' +\n            'This may be passed as a generic such as `graphql.persisted<typeof document>` or as the second argument.',\n          file: position.file,\n          line: position.line,\n          col: position.col,\n        });\n        continue;\n      }\n\n      let foundNode: ts.CallExpression | null = null;\n      let referencingNode: ts.Node = call;\n      if (docArg && (ts.isCallExpression(docArg) || ts.isIdentifier(docArg))) {\n        const result = getDocumentReferenceFromDocumentNode(\n          docArg,\n          sourceFile.fileName,\n          pluginInfo\n        );\n        foundNode = result.node;\n        referencingNode = docArg;\n      } else if (typeQuery && ts.isTypeQueryNode(typeQuery)) {\n        const result = getDocumentReferenceFromTypeQuery(\n          typeQuery,\n          sourceFile.fileName,\n          pluginInfo\n        );\n        foundNode = result.node;\n        referencingNode = typeQuery;\n      }\n\n      if (!foundNode) {\n        warnings.push({\n          message:\n            `Could not find reference for \"${referencingNode.getText()}\".\\n` +\n            'If this is unexpected, please file an issue describing your case.',\n          file: position.file,\n          line: position.line,\n          col: position.col,\n        });\n        continue;\n      }\n\n      if (\n        !foundNode ||\n        !ts.isCallExpression(foundNode) ||\n        (!ts.isNoSubstitutionTemplateLiteral(foundNode.arguments[0]) &&\n          !ts.isStringLiteral(foundNode.arguments[0]))\n      ) {\n        warnings.push({\n          message:\n            `The referenced document of \"${referencingNode.getText()}\" contains no document string literal.\\n` +\n            'If this is unexpected, please file an issue describing your case.',\n          file: position.file,\n          line: position.line,\n          col: position.col,\n        });\n        continue;\n      }\n\n      const fragments: FragmentDefinitionNode[] = [];\n      const operation = foundNode.arguments[0].getText().slice(1, -1);\n      if (foundNode.arguments[1] && ts.isArrayLiteralExpression(foundNode.arguments[1])) {\n        unrollTadaFragments(foundNode.arguments[1], fragments, pluginInfo);\n      }\n\n      let document = operation;\n      for (const fragment of fragments) document += '\\n\\n' + print(fragment);\n      documents[hashArg.getText().slice(1, -1)] = document;\n    }\n\n    yield {\n      kind: 'FILE_PERSISTED',\n      filePath,\n      documents,\n      warnings,\n    };\n  }\n}\n\nexport const runPersisted = expose(_runPersisted);\n"],"names":["runPersisted","expose","async","_runPersisted","params","init","typescript","ts","projectPath","path","dirname","configPath","project","Project","tsConfigFilePath","getVirtualPosition","loadVirtualCode","kind","pluginInfo","createPluginInfo","pluginConfig","sourceFiles","getSourceFiles","filter","sourceFile","filePath","resolve","getFilePath","relative","rootPath","startsWith","fileCount","length","compilerNode","fileName","documents","warnings","calls","findAllPersistedCallExpressions","call","position","getFilePosition","getStart","undefined","file","hashArg","arguments","docArg","typeQuery","typeArguments","isStringLiteral","push","message","line","col","foundNode","referencingNode","isCallExpression","isIdentifier","getDocumentReferenceFromDocumentNode","node","isTypeQueryNode","getDocumentReferenceFromTypeQuery","getText","isNoSubstitutionTemplateLiteral","fragments","operation","slice","isArrayLiteralExpression","unrollTadaFragments","document","fragment","print"],"mappings":"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"}